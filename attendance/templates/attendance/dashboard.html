{% extends 'attendance/base.html' %}

{% block title %}Главная{% endblock %}
{% block page_title %}Главная страница{% endblock %}

{% block content %}
    <nav>
        {% if user_role == 'worker' %}
            <form method="post" action="{% url 'check_in_out' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="check_in">
                <button type="submit" class="btn">Пришел на работу</button>
            </form>
            <form method="post" action="{% url 'check_in_out' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="check_out">
                <button type="submit" class="btn btn-danger">Ушел с работы</button>
            </form>
        {% endif %}
        {% if user_role == 'admin' %}
            <a href="{% url 'reports' %}" class="btn">Отчеты</a>
        {% endif %}
    </nav>

    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
        <strong>Текущее время:</strong> {{ current_time|date:"d.m.Y H:i:s" }}
    </div>

    {% if show_other_users %}
        <h2>Сейчас на работе ({{ current_attendances.count }})</h2>
        {% if current_attendances %}
            <table>
                <thead>
                    <tr>
                        <th>ФИО</th>
                        <th>Должность</th>
                        <th>Время прихода</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendance in current_attendances %}
                        <tr>
                            <td>{{ attendance.user.full_name }}</td>
                            <td>{{ attendance.user.position }}</td>
                            <td>{{ attendance.check_in|date:"d.m.Y H:i" }}</td>
                            <td class="status-present">{{ attendance.status }}</td>
                            <td><a href="{% url 'user_detail' attendance.user.id %}" class="btn">Подробно</a></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Никто не находится на работе</p>
        {% endif %}

        <h2>Последние записи посещаемости</h2>
        <table>
            <thead>
                <tr>
                    <th>ФИО</th>
                    <th>Должность</th>
                    <th>Приход</th>
                    <th>Уход</th>
                    <th>Часы работы</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for attendance in recent_attendances %}
                    <tr>
                        <td>{{ attendance.user.full_name }}</td>
                        <td>{{ attendance.user.position }}</td>
                        <td>{{ attendance.check_in|date:"d.m.Y H:i" }}</td>
                        <td>
                            {% if attendance.check_out %}
                                {{ attendance.check_out|date:"d.m.Y H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if attendance.get_work_duration %}
                                {{ attendance.get_work_duration }} ч
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="{% if attendance.is_present %}status-present{% else %}status-away{% endif %}">
                            {{ attendance.status }}
                        </td>
                        <td><a href="{% url 'user_detail' attendance.user.id %}" class="btn">Подробно</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <h2>Ваша посещаемость сегодня</h2>
        {% if recent_attendances %}
            <table>
                <thead>
                    <tr>
                        <th>Приход</th>
                        <th>Уход</th>
                        <th>Часы работы</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendance in recent_attendances %}
                        {% if attendance.check_in|date:"d.m.Y" == current_time|date:"d.m.Y" %}
                            <tr>
                                <td>{{ attendance.check_in|date:"H:i" }}</td>
                                <td>
                                    {% if attendance.check_out %}
                                        {{ attendance.check_out|date:"H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if attendance.get_work_duration %}
                                        {{ attendance.get_work_duration }} ч
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="{% if attendance.is_present %}status-present{% else %}status-away{% endif %}">
                                    {{ attendance.status }}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Сегодня еще не было записей посещаемости</p>
        {% endif %}
    {% endif %}
{% endblock %}